<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>ZXC - Perfil</title>
    <script src="https://cdn.tailwindcss.com"></script><script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        html { font-family:'Inter',sans-serif; -webkit-tap-highlight-color:transparent; }
        :root { --bg: #1f2937;--txt: #f3f4f6;--surf: #374151;--p-soft: #60a5fa; } /* VARIABLES POR DEFECTO (DARK) */
        .light-mode { --bg: #f9fafb; --txt: #111827; --surf: #ffffff; } 
        .light-mode header, .light-mode footer { border-color: #e5e7eb; }
        html, body { background-color: var(--bg); color: var(--txt); transition: background .3s, color .3s; }   
        #app-container { width:100%; margin:0 auto; min-height:100vh; display:flex; flex-direction:column; box-shadow:0 0 20px rgba(0,0,0,.2); position:relative; transition:max-width .4s ease-in-out; }
        #app-container { background-color: var(--bg); }
        .mode-mobile { max-width:500px; }
        .mode-desktop { max-width:100%!important; }
        header,footer { width:100%; max-width:inherit; z-index:500; left:50%; transform:translateX(-50%); position:fixed; background:var(--surf); border-color:#4b5563; }
        header { background: #374151 !important;color: #f3f4f6 !important;border-color: #4b5563 !important;}
        header h1 { color: white !important; }       
        main { flex-grow:1; overflow-y:auto; padding:76px 1rem 72px; }
        .footer-btn { display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:.75rem; color:var(--txt); cursor:pointer; transition:color .2s; }
        .footer-btn:hover { color:#152c94; }
        .footer-btn.active { color:var(--p-soft); font-weight:700; }
        .modal-overlay { position:fixed; inset:0; background:rgba(17,24,39,.8); backdrop-filter:blur(4px); z-index:100; display:flex; justify-content:center; align-items:center; }
        .modal-content { background:var(--surf); border:1px solid #4b5563; border-radius:1rem; width:90%; max-width:320px; }
        .light-mode .modal-content { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .hidden { display:none; }
        .btn-disabled { opacity: 0.3 !important;cursor: not-allowed !important;pointer-events: none !important;filter: grayscale(1); }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>
    <style>
        /* ESTILOS ESPEC√çFICOS DE LA SECCI√ìN (SPA FormData) */
        .input-form{margin-top:0.25rem;display:block;width:100%;padding:0.5rem 1rem;background-color:#1f2937;border:1px solid #4b5563;border-radius:0.5rem;color:white;outline:none}
        .input-form:focus{border-color:#3b82f6}
        select option { background-color: #1f2937 !important; color: #d1d5db !important; }
        select {color-scheme: dark; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%2360a5fa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>');
            cursor: pointer; filter: none; 
        }
        
    </style>
</head>
<body class="dark">
    <div id="app-container" class="mode-mobile shadow-xl">
        <header class="top-0 h-14 border-b flex items-center justify-between px-6">
            <h1 class="text-xl font-bold text-white truncate mr-2">Cargando...</h1>
            <div class="flex items-center gap-3">
                <button class="p-2" onclick="toggleView()"><div id="view-icon-container"></div></button>
                <button class="p-2 text-red-400 rounded-full hover:bg-gray-600" onclick="logout()"><i data-lucide="log-out" class="w-6 h-6"></i></button>
            </div>
        </header>

        <main id="main-content" class="relative"> 
            <div id="global-loader" class="hidden absolute inset-x-20 top-1/3 h-fit z-[400] flex items-center justify-center ...">
                <div class="flex flex-col items-center p-8 bg-gray-800/95 border border-blue-500/40 rounded-2xl shadow-2xl min-w-[320px] transform -translate-y-10">
                    <div class="relative mb-4">
                        <i data-lucide="loader-2" class="w-10 h-10 text-blue-400 animate-spin"></i>
                    </div>
                    <span class="text-blue-400 font-bold text-sm tracking-wider uppercase text-center">Cargando Base de Datos</span>
                    <p class="text-gray-400 text-[10px] mt-2 text-center leading-relaxed">
                        Sincronizando registros con Google Sheets<br>Por favor, espere.
                    </p>
                </div>
            </div>

            <div id="DetalleDataContent" class="p-4 bg-gray-800 rounded-xl border border-gray-700 shadow-2xl">
                <div class="flex flex-col border-b-2 border-gray-600 pb-2 mb-2 gap-2">                    
                    <div class="w-full text-left">
                        <h3 id="viewTitle" class="text-[22px] font-bold text-blue-400 border-b-2 border-gray-600">Detalle Selecci√≥n</h3>
                    </div>
                    <div class="flex flex-wrap gap-2 w-full justify-end items-center">                        
                        <button onclick="duplicateCurrentRecord()" class="text-gray-400 hover:scale-110 transition-transform" title="Duplicar como Nuevo">
                            <i data-lucide="copy-plus" class="w-6 h-6"></i>
                        </button>                        
                        <button onclick="DeleteRecord()" class="text-gray-400 hover:scale-110 transition-transform pr-2" title="Borrar Registro">
                            <i data-lucide="trash-2" class="w-6 h-6"></i>
                        </button>                       
                        <i id="header-icon-fixed-view" data-lucide="lock" class="w-6 h-6 text-blue-400 hidden"></i>                        
                        <button onclick="showRegisterMode()" class="text-green-400 hover:scale-110 transition-transform border-l-2 border-gray-600 pl-4" title="Nuevo Registro">
                            <i data-lucide="file-plus-2" class="w-6 h-6"></i>
                        </button>                        
                        <button onclick="showEditMode()" class="text-yellow-400 hover:scale-110 transition-transform" title="Editar Registro">
                            <i data-lucide="file-pen" class="w-6 h-6"></i>
                        </button>                       
                        <button onclick="closeFormAndReturn()" class="text-blue-400 hover:scale-110 transition-transform pr-4" title="Regresar a Datos">
                            <i data-lucide="circle-arrow-left" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                <div id="perfilBodyContent" class="space-y-1 pb-20"></div>
            </div>

            <div id="EditDataContent" class="hidden p-4 bg-gray-800 rounded-xl border border-gray-700 shadow-2xl">
                <div class="flex flex-col border-b-2 border-gray-600 pb-2 mb-2 gap-2"> 
                    <div class="w-full text-left">
                        <h2 id="formTitle" class="text-[22px] font-bold text-white border-b-2 border-gray-600">Editar Selecci√≥n</h2>
                    </div> 
                    <div class="flex flex-wrap gap-3 w-full justify-end items-center">  
                        <div class="flex items-center gap-1 bg-gray-800/40 px-2">
                            <i data-lucide="lock" class="w-4 h-4 text-red-400"></i>                           
                            <button type="button" onclick="toggleRecordStatus('edit')" class="focus:outline-none flex items-center px-1">
                                <i id="toggle-icon-edit" data-lucide="toggle-right" class="w-6 h-6 transition-colors"></i>
                            </button>
                            <i data-lucide="lock-open" class="w-4 h-4 text-green-400"></i>
                            <input type="hidden" name="PREFIX_TYPEREG" id="input-typereg-edit">
                        </div>
                        <button onclick="showViewMode()" class="text-red-400 hover:scale-110 transition-transform border-l-2 border-gray-600 pl-4 pr-4">
                            <i data-lucide="circle-x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>                
                
                <form id="editDataForm" novalidate class="space-y-1">
                    <input type="hidden" id="formAction" name="action" value="editDynamicDataTD">                   
                    <div id="editDataFormFields" class="space-y-1"></div>                   
                    <button id="submitBtn" type="submit" class="w-full bg-blue-600 mt-6 py-4 rounded-lg font-bold text-white hover:bg-blue-700 transition-all active:scale-95 shadow-lg flex items-center justify-center gap-2">
                        <span>Guardar Cambios</span>
                        <i data-lucide="save" class="w-5 h-5"></i>
                    </button>
                </form>               
                <p class="text-sm text-gray-400 text-center pt-4 pb-12">
                    Los campos que no sean modificados mantendr√°n su valor original.
                </p>
            </div>
        </main>

        <footer id="app-footer" class="bottom-0 h-18 border-t flex items-center justify-around px-2 py-1">
            <button class="footer-btn" data-section="Base"><i data-lucide="house-plus" class="w-6 h-6"></i><span>Base</span></button>
            <button id="btn-datos" class="footer-btn active" data-section="Datos"><i data-lucide="database" class="w-6 h-6"></i><span>Datos</span></button>
            <button id="btn-agregar" class="footer-btn" data-section="Agregar"><i data-lucide="plus-circle" class="w-6 h-6"></i><span>Agregar</span></button>
            <button class="footer-btn" data-section="Perfil"><i data-lucide="user" class="w-6 h-6"></i><span>Perfil</span></button>
            <button class="footer-btn" data-section="Configuracion"><i data-lucide="settings" class="w-6 h-6"></i><span>Config</span></button>
        </footer>
    </div>

    <div id="system-modal" class="hidden modal-overlay">
        <div class="modal-content p-6 text-center max-w-xs">
            <div id="sys-modal-icon" class="mb-4 flex justify-center"></div>
            <h3 id="sys-modal-title" class="text-lg font-bold text-white mb-2"></h3>
            <p id="sys-modal-text" class="text-gray-400 text-sm mb-4"></p>
            
            <div id="sys-modal-input-container" class="hidden mb-6">
                <input type="text" id="sys-modal-input" 
                    class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white text-center focus:border-blue-500 outline-none"
                    placeholder="Escribe aqu√≠...">
            </div>

            <div id="sys-modal-actions" class="flex gap-3 justify-center"></div>
        </div>
    </div>

<script>
    const KEYS={NOMBRE:'Usuario_Nombre',PERFIL:'Usuario_Perfil',CORREO:'Usuario_Correo',VIEW_MODE:'App_View_Mode',THEME:'App_Theme',TIENDA:'Usuario_Tienda',TIENDA_ID:'Usuario_Tienda_ID',USUARIO_ID:'Usuario_ID'};
    document.addEventListener('DOMContentLoaded',()=>{if(!localStorage.getItem(KEYS.CORREO))window.location.replace('index.html');initUI();if(window.lucide)lucide.createIcons()});
    function initUI(){
        const nom = localStorage.getItem(KEYS.NOMBRE);
        if(nom) document.querySelector('h1').textContent = `¬°Hola, ${nom.trim().split(/\s+/)[0]}!`;
        applyViewMode(localStorage.getItem(KEYS.VIEW_MODE) || 'mobile');
        document.querySelectorAll('.footer-btn').forEach(b => b.onclick = () => loadContent(b.getAttribute('data-section')));
        if(!localStorage.getItem(KEYS.INPUT_ID)){['btn-agregar'].forEach(id => {const el = document.getElementById(id);if(el) el.classList.add('btn-disabled'); });}
    }
    function toggleView(){const m=localStorage.getItem(KEYS.VIEW_MODE)==='desktop'?'mobile':'desktop';localStorage.setItem(KEYS.VIEW_MODE,m);applyViewMode(m)}
    function applyViewMode(m){
        const c=document.getElementById('app-container'),i=document.getElementById('view-icon-container');
        if(m==='desktop'){c.classList.replace('mode-mobile','mode-desktop');i.innerHTML='<i data-lucide="smartphone" class="w-5 h-5 text-blue-400"></i>'}
        else{c.classList.replace('mode-desktop','mode-mobile');i.innerHTML='<i data-lucide="monitor" class="w-5 h-5 text-emerald-400"></i>'}
        if(window.lucide)lucide.createIcons();
    }
    async function loadContent(s){
        const NAV={'Base':'Base2.html','Inicio':'Inicio.html','Datos': 'Datos2.html','Agregar':'AgregarDat.html','Perfil':'PerfilUser2.html','Configuracion':'ConfigApp2.html'};
        if(['Agregar'].includes(s) && !localStorage.getItem(KEYS.INPUT_ID)){return showSystemModal({title:'Acceso Imposible', text:'Registre el dato CLAVE para su b√∫squeda en la secci√≥n correspondiente.', type:'warning'});}    
        if(s==='Configuracion' && localStorage.getItem(KEYS.PERFIL)!=='Admin') return showSystemModal({title:'Acceso Denegado',text:'Solo administradores.',type:'warning'});
        if(NAV[s]) window.location.href=NAV[s];
    }     
    function toggleTheme() {
        const isLight = document.documentElement.classList.toggle('light-mode');
        localStorage.setItem(KEYS.THEME, isLight ? 'light' : 'dark');
        renderTiendaFooter();
        if(window.lucide) lucide.createIcons();
    }
    function applyTheme() {
        const theme = localStorage.getItem(KEYS.THEME) || 'dark';
        if (theme === 'light') {document.documentElement.classList.add('light-mode');} 
        else {document.documentElement.classList.remove('light-mode');}
    }
    function toggleGlobalLoader(show) {
        const loader = document.getElementById('global-loader');
        if (loader) { loader.classList.toggle('hidden', !show);
        if (show && window.lucide) lucide.createIcons(); }
    }
    function formatNumberWithDots(v) {
        if (!v && v !== 0) return '';
        const number = parseFloat(String(v).replace(',', '.'));
        if (isNaN(number)) return v;
        const decimals = Math.abs(number - Math.round(number)) < 0.001 ? 0 : 2;
        return new Intl.NumberFormat('es-ES', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(number);
    }
    function formatDate(v) {
        if (!v) return 'N/A';
        const dateStr = String(v).trim();
        if (dateStr.includes('/') && dateStr.split('/').length === 3) {
            return dateStr; 
        }
        if (dateStr.includes('-')) {
            const parts = dateStr.split('T')[0].split('-'); 
            if (parts.length === 3) {
                return `${parts[2].padStart(2,'0')}/${parts[1].padStart(2,'0')}/${parts[0]}`;
            }
        }
        if (v instanceof Date) {
            return `${v.getDate().toString().padStart(2,'0')}/${(v.getMonth()+1).toString().padStart(2,'0')}/${v.getFullYear()}`;
        }
        return dateStr;
    }
    function formatDateTime(v) {
        if (!v) return 'N/A';
        const d = new Date(v);
        if (isNaN(d.getTime())) return v;
        return `${formatDate(v)} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}`;
    }
    function getFormattedValue(key, value) {
        if (value === null || value === undefined || value === '') return '';
        const cleanKey = String(key).toUpperCase();                 
        if (cleanKey.includes('REGISTRODATA')) { return formatDateTime(value); }
        if (cleanKey.includes('FECHA')) { return formatDate(value); }  
        const isPotentiallyNumber = typeof value === 'number' || 
            (!isNaN(parseFloat(value)) && isFinite(value) && String(value).length < 15); 
        if (isPotentiallyNumber && !cleanKey.includes('ID') && !cleanKey.includes('DATA')) {
            return formatNumberWithDots(value);
        }
        return value;
    }
    function showSystemModal({
        title, 
        text, 
        type = 'info', 
        showCancel = false, 
        isPrompt = false, 
        placeholder = '...'
    }) {
        return new Promise(res => {
            const m = document.getElementById('system-modal'),
                ti = document.getElementById('sys-modal-title'),
                te = document.getElementById('sys-modal-text'),
                ic = document.getElementById('sys-modal-icon'),
                ac = document.getElementById('sys-modal-actions'),
                iCont = document.getElementById('sys-modal-input-container'),
                input = document.getElementById('sys-modal-input');

            // Configuraci√≥n visual b√°sica
            ti.textContent = title;
            te.textContent = text;
            const colors = { warning: 'text-amber-400', info: 'text-blue-400', danger: 'text-red-400' },
                icons = { warning: 'alert-triangle', info: 'info', danger: 'trash-2' };
            
            ic.innerHTML = `<i data-lucide="${icons[type]}" class="w-12 h-12 ${colors[type]}"></i>`;
            ac.innerHTML = '';
            
            // Manejo del Input (Prompt)
            if (isPrompt) {
                iCont.classList.remove('hidden');
                input.value = '';
                input.placeholder = placeholder;
                setTimeout(() => input.focus(), 100); // Auto-focus
            } else {
                iCont.classList.add('hidden');
            }

            // Funci√≥n para cerrar y resolver
            const close = (val) => {
                m.classList.add('hidden');
                res(val);
            };

            // Bot√≥n Cancelar (si se requiere)
    // --- BOT√ìN CANCELAR (Rojo que pasa a Gris con borde Rojo) ---
    if (showCancel || isPrompt) {
        const bc = document.createElement('button');
        // bg-red-600: Fondo inicial rojo
        // hover:bg-gray-700: Cambia a gris al pasar el rat√≥n
        // hover:border-red-500 hover:border-2: A√±ade el borde rojo en hover
        bc.className = 'px-4 py-2 rounded-lg bg-gray-600 text-white text-sm font-medium border-2 border-transparent hover:bg-red-700 hover:border-red-500 transition-all duration-300';
        bc.textContent = 'Cancelar';
        bc.onclick = () => close(isPrompt ? null : false);
        ac.appendChild(bc);
    }

    // --- BOT√ìN ACEPTAR (Azul que pasa a Rojo con borde Azul) ---
    const bp = document.createElement('button');
    // bg-blue-600: Fondo inicial azul
    // hover:bg-red-600: Cambia a rojo al pasar el rat√≥n
    // hover:border-blue-400 hover:border-2: A√±ade el borde azul en hover
    bp.className = 'px-6 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium border-2 border-transparent hover:bg-blue-800 hover:border-blue-400 transition-all duration-300';
    bp.textContent = 'Aceptar';
    bp.onclick = () => {
        if (isPrompt) {
            close(input.value);
        } else {
            close(true);
        }
    };
    ac.appendChild(bp);
            m.classList.remove('hidden');
            if (window.lucide) lucide.createIcons();
        });
    }    
    function logout(){localStorage.clear();window.location.href='index.html'}

</script>

<script>
    function setupNombreCAutoCalculate(tablePrefix) {
        const n1 = document.getElementById(`input-${tablePrefix}NOMBRE1`);
        const n2 = document.getElementById(`input-${tablePrefix}NOMBRE2`);
        const nc = document.getElementById(`input-${tablePrefix}NOMBREC`);
        if (!n1 || !n2 || !nc) return;
        const particles = ["de los", "de la", "de", "del", "mc"];
        const processNombre1 = (text) => {
            const val = text.trim();
            if (!val) return "";
            const parts = val.split(/\s+/);               
            for (let i = 0; i < parts.length; i++) {
                for (let p of particles) {
                    const pParts = p.split(" ");
                    if (parts.slice(i, i + pParts.length).join(" ").toLowerCase() === p) {
                        const blockBefore = parts.slice(0, i + pParts.length).join(" ");
                        if (parts[i + pParts.length]) {
                            const initial = parts[i + pParts.length].charAt(0).toUpperCase();
                            return `${blockBefore} ${initial}.`; // Ej: MARIA DE LOS C.
                        }
                        return blockBefore;
                    }
                }
            }
            let res = parts[0];
            if (parts[1]) res += " " + parts[1].charAt(0).toUpperCase() + ".";
            return res;
        };
        const processNombre2 = (text) => {
            const val = text.trim();
            if (!val) return "";
            if (val.toLowerCase().startsWith("o'")) {
                const parts = val.split(/\s+/);
                return parts[1] ? `${parts[0]} ${parts[1].charAt(0).toUpperCase()}.` : parts[0];
            }
            const parts = val.split(/\s+/);
            for (let p of particles) {
                const pParts = p.split(" ");
                if (parts.slice(0, pParts.length).join(" ").toLowerCase() === p) {
                    const mainBlock = parts.slice(0, pParts.length + 1).join(" ");
                    const remaining = parts.slice(pParts.length + 1);
                    return remaining.length > 0 ? `${mainBlock} ${remaining[0].charAt(0).toUpperCase()}.` : mainBlock;
                }
                for (let i = 1; i < parts.length; i++) {
                    if (parts.slice(i, i + pParts.length).join(" ").toLowerCase() === p) {
                        const mainBlock = parts.slice(0, i + pParts.length + 1).join(" ");
                        const remaining = parts.slice(i + pParts.length + 1);
                        return remaining.length > 0 ? `${mainBlock} ${remaining[0].charAt(0).toUpperCase()}.` : mainBlock;
                    }
                }
            }
            return parts[1] ? `${parts[0]} ${parts[1].charAt(0).toUpperCase()}.` : parts[0];
        };
        const calculate = () => {
            const n1Val = processNombre1(n1.value);
            const n2Val = processNombre2(n2.value);               
            let final = n1Val;
            if (n2Val) final += (final ? " " : "") + n2Val;
            nc.value = final.toUpperCase();
        };
        n1.addEventListener('input', calculate);
        n2.addEventListener('input', calculate);
    }

    async function loadTableNames() {
        const tienda = localStorage.getItem(KEYS.TIENDA) || 'DEFAULT';
        try {
            const r = await fetch(`${GAS_SCRIPT_URL}?action=getTableFriendlyNames&appTienda=${tienda}`);
            const res = await r.json();
            if (res.success) {
                localStorage.setItem('TABLE_FRIENDLY_NAMES', JSON.stringify(res.data));
            }
        } catch (e) { console.error("Error cargando nombres amigables", e); }
    }

    function getFriendlyTableName(technicalName) {
        const raw = localStorage.getItem('TABLE_FRIENDLY_NAMES');
        const friendlyNames = JSON.parse(raw || '{}');
        return friendlyNames[technicalName]?.label || technicalName;
    }

    function updateFormTitle(technicalName, isNew = false) {
        const label = getFriendlyTableName(technicalName);
        const formTitleEl = document.getElementById('formTitle');
        if (formTitleEl) {
            const accion = isNew ? "Nuevo Registro" : "Editar Selecci√≥n";
            formTitleEl.textContent = `${accion}: ${label}`;
        }
    }    

    function getTablePrimaryKey(headers, tableName) {
        const prefix = tableName.split('_')[0].toUpperCase();
        return headers.find(h => h.trim().toUpperCase() === `${prefix}ID`) || headers[0];
    }

    function hydrateAllSelects(hydrations) {
        hydrations.forEach(item => {
            const el = document.getElementById(item.id);
            if (!el) return;
            const flat = item.options.flatMap(opt => {
                try { 
                    return (typeof opt === 'string' && opt.trim().startsWith('[')) ? JSON.parse(opt) : opt; 
                } catch { return opt; }
            });
            const unique = [...new Set(flat)].filter(Boolean).sort();
            const hasCurrentValue = item.current && String(item.current).trim() !== "";
            let optionsHTML = "";
            if (!item.isDuplicate && !hasCurrentValue) {
                optionsHTML += `<option value="" selected>-- Seleccionar --</option>`;
            } else {
                optionsHTML += `<option value="">-- Seleccionar --</option>`;
            }
            optionsHTML += unique.map(val => {
                const valStr = String(val).trim();
                const currStr = String(item.current).trim();
                const isSelected = valStr === currStr;                
                return `<option value="${val}" ${isSelected ? 'selected' : ''}>${val}</option>`;
            }).join('');
            el.innerHTML = optionsHTML;
            if (hasCurrentValue) {
                el.value = item.current;
            }
        });
    }     
    
console.group("üîç REVISI√ìN DE LOCALSTORAGE");
console.log("üë§ Datos de Usuario (KEYS):");
Object.entries(KEYS).forEach(([key, storageKey]) => {
console.log(`   ${key}: ${localStorage.getItem(storageKey)}`);
});

console.log("üìä Configuraci√≥n de Tabla (TABLE_CONFIG):");
console.table(JSON.parse(localStorage.getItem('TABLE_CONFIG') || '{}'));

console.log("üìù Datos de la Fila (TABLE_DATA):");
console.table(JSON.parse(localStorage.getItem('TABLE_DATA') || '{}'));
console.groupEnd();
</script>

<script>
    const GAS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyVcnPmbbR9RXy6ekkvHT6ocTgm0Rsf1wxNQvQpSbEt7ubGVwBhxKqhNm0YeO_dI_XJIg/exec";
    const STORAGE_CONFIG = 'TABLE_CONFIG';
    const STORAGE_DATA = 'TABLE_DATA';
    document.addEventListener('DOMContentLoaded', async () => { 
        if (!localStorage.getItem(KEYS.CORREO)) {
            window.location.replace('index.html');
            return;
        }       
        const rawData = localStorage.getItem(STORAGE_DATA);
        const rawConfig = localStorage.getItem(STORAGE_CONFIG);        
        if (rawData && rawConfig) {
            const data = JSON.parse(rawData);
            const config = JSON.parse(rawConfig);
            const isNew = data.IS_NEW === true;
            const tableName = data.TABLA_ORIGEN;           
            if (!tableName) {
                window.location.href = 'Datos2.html';
                return;
            }           
            if (window.toggleGlobalLoader) toggleGlobalLoader(true);
            await fetchMasterData(tableName);
            if (window.toggleGlobalLoader) toggleGlobalLoader(false);
            renderProfile();            
            const friendlyName = getFriendlyTableName(tableName);
            if (document.getElementById('viewTitle')) {
                document.getElementById('viewTitle').textContent = `Detalle: ${friendlyName}`;
            }          
            const form = document.getElementById('editDataForm');
            if (isNew) {
                showRegisterMode(); 
                if (form) form.onsubmit = handleInsertSubmit;
            } else {
                renderFields(config, data, false);
                if (form) form.onsubmit = handleEditSubmit;
            }
        } else {
            window.location.href = 'Datos2.html';
        }
    });

    document.addEventListener('input', (e) => {
        const target = e.target;
        if (!target.name) return;
        const name = target.name.toUpperCase();
        if (name.includes('MONTO') || name.includes('CANTIDAD') || name.includes('TOTAL') || name.includes('TASA') || name === 'TD101DAT0X') {
            applyMask(target);
            target.classList.remove('italic', 'text-gray-500/60');
        }
    });

    document.addEventListener('focusin', (e) => {
        const target = e.target;
        if (!target.name) return;
        
        const name = target.name.toUpperCase();
        if (name.includes('MONTO') || name.includes('CANTIDAD') || name.includes('TOTAL') || name.includes('TASA') || name === 'TD101DAT0X') {
            if (target.value.includes('.') && !target.value.includes(',')) {
                let currentVal = parseFloat(target.value);
                if (!isNaN(currentVal)) {
                    target.value = currentVal.toLocaleString('es-ES', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                }
            } else if (target.value === "") {
                target.value = "0,00";
            }
        }
    });

function showViewMode() {
    const data = JSON.parse(localStorage.getItem('TABLE_DATA') || '{}');
    if (data.IS_NEW === true) {
        window.location.href = 'Datos2.html';
        return;
    }

    // --- REPARACI√ìN AQU√ç ---
    // Restauramos la acci√≥n por defecto para que renderFields no vea "register" la pr√≥xima vez
    const actionInput = document.getElementById('formAction');
    if (actionInput) actionInput.value = "updateDynamicDataTD";

    const detailPanel = document.getElementById('DetalleDataContent');
    const editPanel = document.getElementById('EditDataContent');           
    if (detailPanel && editPanel) {
        detailPanel.classList.remove('hidden');
        editPanel.classList.add('hidden');
    }
}

    function closeFormAndReturn() {
        try {
            const data = JSON.parse(localStorage.getItem(STORAGE_DATA) || '{}');
            console.log("Tabla origen detectada:", data.TABLA_ORIGEN);
            const tableToRemember = data.TABLA_ORIGEN;
            if (tableToRemember) {
                localStorage.setItem('LAST_VISITED_TABLE', tableToRemember);
            }
        } catch (e) {
            console.error("Error al procesar el cierre:", e);
        }
        window.location.href = 'Datos2.html';
    }

    async function toggleRecordStatus(suffix = 'edit') {
        const input = document.getElementById(`input-typereg-${suffix}`);
        if (!input) return;

        const nuevoEstado = (input.value === "Bloqueado") ? "Registrado" : "Bloqueado";
        input.value = nuevoEstado;
        
        // Llamamos a la visualizaci√≥n
        actualizarVisualizacionStatus(suffix, nuevoEstado);

        // SOLO lanzamos el modal si el cambio fue manual y el estado es Bloqueado
        if (nuevoEstado === "Bloqueado" && suffix === 'edit') {
            await showSystemModal({
                title: 'Registro Bloqueado',
                text: 'El formulario se ha puesto en modo de solo lectura.',
                type: 'info'
            });
        }
    }

    function actualizarVisualizacionStatus(suffix, estado) {
        const badge = document.getElementById(`badge-status-${suffix}`);
        const iconToggle = document.getElementById(`toggle-icon-${suffix}`);
        const isBloqueado = (estado === "Bloqueado");

        // 1. Actualizar Badge (si existe)
        if (badge) {
            badge.textContent = estado;
            badge.className = `text-[10px] px-2 py-0.5 rounded-full uppercase font-bold transition-all ${
                isBloqueado ? 'bg-red-500/20 text-red-400 border border-red-500/30' : 'bg-green-500/20 text-green-400 border border-green-500/30'
            }`;
        }

        // 2. Actualizar Iconos del Toggle
        if (iconToggle) {
            iconToggle.style.color = isBloqueado ? "#ef4444" : "#22c55e";
            iconToggle.setAttribute('data-lucide', isBloqueado ? 'toggle-left' : 'toggle-right');
        }

        // 3. Bloquear/Desbloquear campos
        if (suffix === 'edit') {
            toggleFormLock(isBloqueado);
        }

        if (window.lucide) lucide.createIcons();
    }

    function toggleGastosType() {
        const input = document.getElementById('input-TD202DAT01');
        const badge = document.getElementById('badge-gasto-type');
        const iconToggle = document.getElementById('icon-gasto-type');
        
        // Eliminamos la referencia al header para que no lo altere nunca
        if (!input || !badge || !iconToggle) return;
        
        const isNowFijo = input.value !== "Fijo";
        
        if (isNowFijo) {
            input.value = "Fijo";
            badge.innerHTML = `<i data-lucide="lock" class="w-6 h-6"></i>`;
            badge.className = "flex items-center justify-center p-1 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/30 transition-all";
            iconToggle.style.color = "#3b82f6";
            iconToggle.setAttribute('data-lucide', 'toggle-right');
            // Se elimin√≥ la l√≠nea del iconHeaderEdit
        } else {
            input.value = "Eventual";
            badge.innerHTML = `<i data-lucide="calendar-clock" class="w-6 h-6"></i>`;
            badge.className = "flex items-center justify-center p-1 rounded-full bg-purple-500/20 text-purple-400 border border-purple-500/30 transition-all";
            iconToggle.style.color = "#a855f7";
            iconToggle.setAttribute('data-lucide', 'toggle-left');
            // Se elimin√≥ la l√≠nea del iconHeaderEdit
        }
        
        if(window.lucide) lucide.createIcons();
    }

function toggleFormLock(isLocked) {
    const form = document.getElementById('editDataForm');
    if (!form) return;

    // 1. Seleccionamos inputs, selects y textareas
    const inputs = form.querySelectorAll('input:not(#input-typereg-edit), select, textarea');
    
    inputs.forEach(el => {
        // --- EL AJUSTE VITAL ---
        // Si el campo tiene el "escudo" de TABLE_CONFIG, NO lo habilitamos nunca
        if (el.hasAttribute('data-permanent-lock')) {
            el.readOnly = true;
            el.classList.add('cursor-default');
            if (el.tagName === 'SELECT') el.disabled = true;
            return; // Saltamos este elemento
        }

        // L√≥gica normal para campos editables
        if (isLocked) {
            el.classList.add('opacity-40', 'cursor-not-allowed');
            el.style.pointerEvents = 'none';
            el.readOnly = true; 
            if (el.tagName === 'SELECT') el.disabled = true;
        } else {
            el.classList.remove('opacity-40', 'cursor-not-allowed');
            el.style.pointerEvents = 'auto';
            el.readOnly = false;
            if (el.tagName === 'SELECT') el.disabled = false;
        }
    });

    // 2. Bot√≥n Guardar
    const submitBtn = document.getElementById('submitBtn'); 
    if (submitBtn) {
        submitBtn.disabled = false; 
        submitBtn.classList.remove('opacity-40', 'cursor-not-allowed');
        if (isLocked) {
            submitBtn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Guardar Bloqueo TLF';
        }
        if (window.lucide) lucide.createIcons();
    }

    // 3. Bot√≥n especial de gastos
    const btnGasto = document.querySelector('button[onclick="toggleGastosType()"]');
    if (btnGasto) {
        btnGasto.style.display = isLocked ? 'none' : 'flex';
    }        
}

    function applyMask(input) {
        let value = input.value.replace(/\D/g, '');
        let numericValue = parseFloat(value) / 100;
        if (isNaN(numericValue)) { input.value = "0,00"; return; }
        input.value = numericValue.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

function sanitizePayload(formData) {
    // 1. Convertimos el FormData a objeto plano
    const entries = Object.fromEntries(formData.entries());
    
    // 2. Recuperamos la configuraci√≥n para identificar campos calculados
    const config = JSON.parse(localStorage.getItem('TABLE_CONFIG') || '{}');
    
    for (let key in entries) {
        const k = key.toUpperCase().trim();
        
        // --- EXCLUSI√ìN DE CAMPOS CALCULADOS ---
        // Si el campo es calculado en la config, lo eliminamos. 
        // Al no enviarlo, el Backend entrar√° en modo "Preservar F√≥rmula".
        if (config[key] && (config[key].Es_Calculado === true || config[key].Es_Calculado === "true")) {
            delete entries[key];
            console.log(`üõ°Ô∏è Sanitize: Excluyendo ${key} por ser campo calculado.`);
            continue; 
        }

        let val = String(entries[key] || "").trim();

        // --- PROCESAMIENTO DE FECHAS ---
        if (k.includes('FECHA')) {
            if (val.includes('-')) {
                const parts = val.split('-');
                if (parts.length === 3) {
                    entries[key] = `${parts[2]}/${parts[1]}/${parts[0]}`;
                }
            }
            continue;
        }

        // --- PROCESAMIENTO DE N√öMEROS ---
        const camposNumericos = ['MONTO', 'CANTIDAD', 'TOTAL', 'TD101DAT01'];
        if (camposNumericos.some(t => k.includes(t))) {
            if (val === "" || val === "0,00") {
                entries[key] = 0;
                continue;
            }
            if (val.includes(',')) {
                val = val.replace(/\./g, '').replace(',', '.');
            } else {
                val = val.replace(/\s/g, '');
            }               
            const numericVal = parseFloat(val);
            entries[key] = isNaN(numericVal) ? 0 : numericVal;
        }
    }       
    return entries;
}

function resultadoBuscarX(valorSeleccionado, columnaCalculada, prefijoBuscado) {
    const lastResponse = JSON.parse(localStorage.getItem('LAST_QUERY_RESPONSE') || '{}');
    const masterFields = lastResponse.masterFields || [];

    // Normalizamos el valor seleccionado para comparar
    const valorLimpio = String(valorSeleccionado || "").trim().toUpperCase();

    // 1. Buscamos la columna que sirve de "llave" de b√∫squeda (IDNOMBRE)
    const columnaNombres = masterFields.find(f => 
        f.Nombre_Tabla.startsWith(prefijoBuscado) && 
        f.Encabezado_Tabla === `${prefijoBuscado}IDNOMBRE`
    );

    if (!columnaNombres) return "";

    // 2. Buscamos el √≠ndice comparando todo como strings
    const filaIndex = columnaNombres.Valores_Encabezado.findIndex(v => 
        String(v || "").trim().toUpperCase() === valorLimpio
    );

    if (filaIndex !== -1) {
        // 3. Buscamos la columna destino (ej: TD101ID)
        const columnaDestino = masterFields.find(f => 
            f.Nombre_Tabla.startsWith(prefijoBuscado) && 
            f.Encabezado_Tabla === columnaCalculada
        );
        
        return columnaDestino ? columnaDestino.Valores_Encabezado[filaIndex] : "";
    }

    return "";
}
function renderFields(config, data, isNew = false) {
    const container = document.getElementById('editDataFormFields');
    const tableOrigin = data.TABLA_ORIGEN || "";
    const prefix = tableOrigin.split('_')[0].toUpperCase();
    const tv001 = JSON.parse(localStorage.getItem('FULL_DATA_TV001') || '[]');
    const selectHydrations = [];
    const excludedIDTables = ['TD101', 'TD102', 'TD201'];

    const actionInput = document.getElementById('formAction');
    const isInsertAction = actionInput?.value === "registerDynamicDataTD";
    const rawStatus = data[`${prefix}TYPEREG`] || "Registrado";

    container.innerHTML = Object.keys(config).map(colId => {
        const field = config[colId];
        const cleanId = colId.toUpperCase().trim();
        const isTableID = cleanId === `${prefix}ID`;

        const configVisible = field.visible !== undefined && String(field.visible).trim() !== "";
        const configEditable = field.editable === true || String(field.editable).toLowerCase() === "true";
        const configCalculated = field.Es_Calculado === true || String(field.Es_Calculado).toLowerCase() === "true";
        const configRequired = field.Es_Obligatorio === true || String(field.Es_Obligatorio).toLowerCase() === "true";

        if (!configVisible && !isTableID) return '';

        let value = (data && data[colId] !== undefined) ? data[colId] : '';
        const isDateOnly = cleanId.includes('FECHA');
        const isNIF = cleanId.endsWith('NIF');

        const canEdit = !isTableID && configEditable && !configCalculated;
        const isRequired = configRequired && canEdit;

        // Limpieza de valores
        if (typeof value === 'string' && value.startsWith('=')) value = '';
        if (isDateOnly && value) value = String(value).split('T')[0];
        if (!isNIF && !isDateOnly && value !== '' && !isNaN(value) && typeof value !== 'boolean') {
            const numValue = parseFloat(value);
            if (numValue % 1 !== 0) value = Number(numValue.toFixed(2));
        }

        if (cleanId.endsWith('TYPEREG') || cleanId.includes('REGISTRODATA') || cleanId.includes('REGISTROUSER')) return '';

        // Render ID
        if (isTableID) {
            if (excludedIDTables.includes(prefix) || !configVisible) {
                return isNew ? '' : `<input type="hidden" name="${colId}" id="input-${cleanId}" value="${value}">`;
            }
            const displayId = (isInsertAction || isNew) ? "*******" : value;
            const isPlaceholderId = displayId === "*******";
            return `
                <div class="border-b border-gray-700/40 py-1">
                    <span class="text-[10px] font-bold text-orange-400 uppercase block -mb-1">${field.label || 'ID Registro'}</span>
                    <div class="flex items-center justify-between min-h-[32px]">
                        <input type="text" name="${colId}" id="input-${cleanId}" value="${displayId}" readonly data-permanent-lock="true"
                            class="text-[22px] ${displayId === "*******" ? 'text-orange-500/60' : 'text-blue-300'} font-bold bg-transparent border-none p-0 m-0 w-full cursor-default outline-none">
                        ${(displayId !== "*******") ? `<span id="badge-status-edit" class="text-[10px] px-2 py-0.5 rounded-full uppercase font-bold whitespace-nowrap">${rawStatus}</span>` : ''}
                    
                        ${isPlaceholderId 
                            ? '<span class="text-[10px] text-orange-500/80 italic font-bold uppercase whitespace-nowrap tracking-tighter pb-3 pr-12">Auto-Asignado</span>'
                            : ""//`<span id="badge-status-edit" class="text-[10px] px-2 py-0.5 rounded-full uppercase font-bold whitespace-nowrap">""${rawStatus}""</span>`
                        }
                    </div>
                </div>`;
        }

        // Selectores
        const masterMatch = tv001.filter(row => row.Encabezado_Tabla?.toUpperCase().trim() === cleanId);
        if (masterMatch.length > 0 && canEdit) {
            const selectId = `select-${cleanId}`;
            selectHydrations.push({ id: selectId, options: masterMatch.map(m => m.Valores_Encabezado), current: value, isDuplicate: (isInsertAction && value !== "") });
            return `
                <div class="border-b border-gray-700/40 py-1">
                    <div class="flex justify-between items-center -mb-1">
                        <span class="text-[10px] font-bold text-blue-400 uppercase block">${field.label}</span>
                        ${isRequired ? '<span class="text-[9px] text-red-400 font-bold italic animate-pulse">REQUERIDO</span>' : ''}
                    </div>
                    <div class="flex items-center h-[32px]">
                        <select name="${colId}" id="${selectId}" ${isRequired ? 'required' : ''} class="text-[16px] text-gray-200 font-medium w-full bg-transparent outline-none p-0 appearance-none cursor-pointer">
                            <option value="${value}">${value || '-- Seleccionar --'}</option>
                        </select>
                    </div>
                </div>`;
        }

        // Campos Est√°ndar
        let inputType = (isDateOnly && canEdit) ? "date" : "text";
        const textStyleClass = !canEdit ? 'text-blue-400 opacity-90' : 'text-yellow-200';
        const labelStyleClass = !canEdit ? 'text-gray-500 font-bold' : 'text-blue-400 font-bold';

        return `
            <div class="border-b border-gray-700/40 py-1">
                <div class="flex justify-between items-center -mb-0.5">
                    <span class="text-[10px] ${labelStyleClass} uppercase block">${field.label}</span>
                    ${isRequired ? '<span class="text-[10px] text-red-400 font-bold italic animate-pulse pr-12">OBLIGATORIO</span>' : ''}
                </div>
                <div class="flex items-center h-[32px]">
                    <input type="${inputType}" name="${colId}" id="input-${cleanId}" value="${value}" 
                        ${!canEdit ? 'readonly tabindex="-1" data-permanent-lock="true"' : ''} 
                        ${isRequired ? 'required' : ''} 
                        class="text-[16px] font-medium w-full bg-transparent outline-none p-0 focus:ring-0 scheme-dark 
                        ${textStyleClass} ${!canEdit ? 'cursor-default' : ''}">
                </div>
            </div>`;
    }).join('');

    // --- L√ìGICA POST-RENDER ---
    const inputH = document.getElementById('input-typereg-edit');
    if (inputH) {
        inputH.name = `${prefix}TYPEREG`; 
        inputH.value = rawStatus; 
        if (typeof actualizarVisualizacionStatus === 'function') {
            actualizarVisualizacionStatus('edit', rawStatus);
        }
    }

    // Sincronizar bloqueo inicial
    setTimeout(() => {
        if (typeof toggleFormLock === 'function') {
            toggleFormLock(rawStatus === "Bloqueado");
        }
    }, 100);

    if (window.lucide) lucide.createIcons();

    // Hidrataci√≥n de selects y c√°lculos
    if (typeof hydrateAllSelects === 'function') {
        hydrateAllSelects(selectHydrations);
        selectHydrations.forEach(sh => {
            const selectEl = document.getElementById(sh.id);
            if (selectEl) {
                selectEl.addEventListener('change', (e) => {
                    const valorSelected = String(e.target.value || "").trim();
                    const prefijoSelector = sh.id.replace('select-', '').substring(0, 5).toUpperCase();
                    Object.keys(config).forEach(colIdCalc => {
                        const conf = config[colIdCalc];
                        if ((conf.Es_Calculado === true || String(conf.Es_Calculado).toLowerCase() === "true") && colIdCalc.toUpperCase().startsWith(prefijoSelector)) {
                            const inputDest = document.getElementById(`input-${colIdCalc.toUpperCase().trim()}`);
                            if (inputDest) {
                                inputDest.value = resultadoBuscarX(valorSelected, colIdCalc, prefijoSelector);
                            }
                        }
                    });
                });
            }
        });
    }
}

function renderProfile() {
    const config = JSON.parse(localStorage.getItem(STORAGE_CONFIG) || '{}');
    const data = JSON.parse(localStorage.getItem(STORAGE_DATA) || '{}');
    const container = document.getElementById('perfilBodyContent');
    if (!container) return;
    
    const prefix = (data.TABLA_ORIGEN || "").split('_')[0].toUpperCase();
    const excludedIDTables = ['TD101', 'TD102', 'TD201'];
    const duplicateBtn = document.getElementById('btn-duplicate-record');
    
    if (duplicateBtn) {
        duplicateBtn.classList.remove('hidden');
        duplicateBtn.style.display = 'block';
    }

    // Definici√≥n de Status para el ID (Sincronizado con renderFields)
    const rawStatus = data[`${prefix}TYPEREG`] || "Registrado";
    const isActuallyBlocked = rawStatus === "Bloqueado";
    const isBlocked = rawStatus.toUpperCase() === 'BLOQUEADO';
    const badgeHtml = `<span class="ml-2 text-[10px] px-2 py-0.5 rounded-full bg-red-500/20 text-red-400 border border-red-500/30 uppercase font-bold">Bloqueado</span>`;

    const statusControlHtml = `
        <div class="flex items-center gap-3">
            <span id="badge-status" class="text-[10px] px-2 py-0.5 rounded-full uppercase font-bold ${isActuallyBlocked ? 'bg-red-500/20 text-red-400 border border-red-500/30' : 'bg-green-500/20 text-green-400 border border-green-500/30'}">
                ${rawStatus}
            </span>
            <input type="hidden" name="${prefix}TYPEREG" id="input-typereg" value="${rawStatus}">
            <div class="w-8 h-8 flex items-center justify-center">
                <i data-lucide="${isActuallyBlocked ? 'lock' : 'check-circle'}" class="w-6 h-6 ${isActuallyBlocked ? 'text-red-400' : 'text-green-400'}"></i>
            </div>
        </div>`;

    container.innerHTML = Object.keys(config).map(colId => {
        const field = config[colId];
        const cleanId = colId.toUpperCase().trim();
        const isTableID = cleanId === `${prefix}ID`;

        // --- FILTRO DE VISIBILIDAD (Sincronizado con TABLE_CONFIG) ---
        const isVisibleAttr = field.visible && String(field.visible).trim() !== "";
        // Si no es visible y no es la PK, lo ignoramos
        if (!isVisibleAttr && !isTableID) return '';

        const value = (data && data[colId] !== undefined) ? data[colId] : '';
        const isIdNombre = cleanId === `${prefix}IDNOMBRE`;
        const isExcluded = excludedIDTables.includes(prefix);
        const isNew = false; 

        // Exclusiones t√©cnicas de sistema
        if (cleanId.endsWith('TYPEREG') || cleanId.includes('REGISTRODATA') || cleanId.includes('REGISTROUSER')) return '';

        // 1. L√ìGICA DE ID (REESTRUCTURADA)
        if (isTableID) {
            // Si es tabla excluida o viene marcado como no visible, no generamos fila visual
            if (isExcluded || !isVisibleAttr) {
                return isNew ? '' : `<input type="hidden" name="${colId}" id="input-${cleanId}" value="${value}">`;
            }

            return `
                <div class="border-b border-gray-700/40 py-1">
                    <span class="text-[10px] font-bold text-orange-400 uppercase block -mb-1">${field.label || 'ID Registro'}</span>
                    <div class="flex items-center justify-between min-h-[32px]">
                        <input type="text" name="${colId}" id="input-${cleanId}" value="${value}" readonly 
                            class="text-[22px] text-blue-300 font-bold bg-transparent outline-none border-none focus:ring-0 p-0 m-0 w-full cursor-default">
                        ${statusControlHtml}
                    </div>
                </div>`;
        }

        // 2. FORMATEO Y L√ìGICA DE CAMPOS REGULARES
        const formattedValue = typeof getFormattedValue === 'function' ? getFormattedValue(colId, value) : value;
        
        // El badge de bloqueado solo se muestra en el campo principal si el registro est√° bloqueado
        let shouldShowBadge = isBlocked && ((isTableID && !isExcluded) || (isIdNombre && isExcluded));
        
        // Jerarqu√≠a visual de textos
        const isCalculated = field.Es_Calculado === true || String(field.Es_Calculado).toLowerCase() === "calc";
        const isHighPriority = cleanId.includes('NOMBREC') || cleanId.includes('DAT01') || isIdNombre;

        // 3. CASO ESPECIAL GASTOS (TD202)
        if (cleanId === 'TD202DAT01') {
            const isFijo = String(value).trim() === "Fijo";
            return `
                <div class="border-b border-gray-700/40 py-1"> 
                    <span class="text-[10px] font-bold text-blue-400/60 uppercase block -mb-0.5">${field.label}</span>
                    <div class="flex items-center h-[32px]">
                        <span class="text-[22px] text-blue-300 font-bold leading-tight">
                            ${formattedValue || '---'}
                        </span>
                        <div class="ml-2 flex items-center justify-center p-1 rounded-full ${isFijo ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' : 'bg-purple-500/20 text-purple-400 border border-purple-500/30'}">
                            <i data-lucide="${isFijo ? 'lock' : 'calendar-clock'}" class="w-3.5 h-3.5"></i>
                        </div>
                    </div>
                </div>`;
        }

        // 4. CLASES DE TEXTO PARA MODO VIEW
        let textClass = 'text-[16px] text-gray-200 font-medium w-full'; // Est√°ndar
        if (isHighPriority || isCalculated) {
            textClass = 'text-[16px] text-blue-300 font-medium w-full'; // Azul para calculados o prioridad
        }

        return `
            <div class="border-b border-gray-700/40 py-1"> 
                <span class="text-[10px] font-bold ${isTableID ? 'text-orange-400/80' : 'text-blue-400/60'} uppercase block -mb-0.5">
                    ${field.label}
                </span>
                <div class="flex items-center h-[32px]">
                    <span class="${textClass} leading-tight">
                        ${formattedValue || '---'}
                    </span>
                    ${shouldShowBadge ? badgeHtml : ''}
                </div>
            </div>`;
    }).join('');
    
    if (window.lucide) lucide.createIcons();
}

    async function executeSubmit(payload, customTitle = '¬°√âxito!') {
        // 1. Desplazar la pantalla al inicio para asegurar visibilidad del loader
        window.scrollTo({ top: 0, behavior: 'smooth' });
        const loader = document.getElementById('global-loader');
        if (loader) {
            loader.querySelector('span').textContent = payload.action.includes('insert') || payload.action.includes('register') ? "Creando Registro" : "Actualizando Datos";
            loader.classList.remove('hidden');
        }
        try {
            const r = await fetch(GAS_SCRIPT_URL, { method: 'POST', body: new URLSearchParams(payload) });
            const res = await r.json();           
            if (res.success) {
                if (res.data) {
                    const currentData = JSON.parse(localStorage.getItem(STORAGE_DATA) || '{}');                   
                    const dataFromServer = { ...res.data };
                    Object.keys(dataFromServer).forEach(key => {
                        if (key.toUpperCase().includes('FECHA') && dataFromServer[key]) {
                            dataFromServer[key] = String(dataFromServer[key]).split('T')[0];
                        }
                    });
                    localStorage.setItem(STORAGE_DATA, JSON.stringify({
                        ...currentData, 
                        ...dataFromServer, 
                        IS_NEW: false
                    }));
                }               
                if (loader) loader.classList.add('hidden');
                await showSystemModal({ title: customTitle, text: res.message, type: 'info' });
                location.reload();
            } else {
                if (loader) loader.classList.add('hidden');
                await showSystemModal({ title: 'Error', text: res.message, type: 'warning' });
            }
        } catch (err) {
            if (loader) loader.classList.add('hidden');
            console.error("Error de red:", err);
            showSystemModal({ title: 'Error', text: 'Error de conexi√≥n con el servidor', type: 'warning' });
        }
    }
    
async function handleEditSubmit(e) {
    e.preventDefault();
    const currentData = JSON.parse(localStorage.getItem(STORAGE_DATA) || '{}');
    const config = JSON.parse(localStorage.getItem('TABLE_CONFIG') || '{}');
    const prefix = currentData.TABLA_ORIGEN.split('_')[0].toUpperCase();

    let payload = {
        action: "editDynamicDataTD",
        TABLA_DESTINO: currentData.TABLA_ORIGEN,
        CAMPO_CLAVE: `${prefix}ID`,
        ...sanitizePayload(new FormData(e.target)),
        [`${prefix}TYPEREG`]: document.getElementById('input-typereg-edit')?.value || currentData[`${prefix}TYPEREG`],
        [`${prefix}RegistroUser`]: localStorage.getItem(KEYS.USUARIO_ID) || "User"
    };

    console.log("üîç PAYLOAD ANTES DEL FILTRO:", { ...payload });

    Object.keys(payload).forEach(key => {
        const campoConfig = config[key];
        if (campoConfig && (campoConfig.Es_Calculado === true || campoConfig.Es_Calculado === "true")) {
            console.log(`üö´ ELIMINANDO DEL PAYLOAD: ${key}`);
            delete payload[key];
        }
    });

    console.log("üöÄ PAYLOAD FINAL (A ENVIAR):", payload);
    
    // Verificaci√≥n visual en la red
    const params = new URLSearchParams(payload);
    console.log("üì° STRING FINAL DE ENV√çO:", params.toString());

    await executeSubmit(payload, 'Registro Procesado');
}

async function handleInsertSubmit(e) {
    e.preventDefault();
    try {
        // 1. Cargar configuraciones y datos de contexto
        const config = JSON.parse(localStorage.getItem('TABLE_CONFIG') || '{}');
        const storageDataRaw = localStorage.getItem('TABLE_DATA'); // Confirmado por el usuario
        const storageData = JSON.parse(storageDataRaw || '{}');

        // 2. DETERMINAR LA TABLA (Prioridad absoluta a TABLE_DATA ya que vienes de la SPA)
        let tablaDestino = storageData.TABLA_ORIGEN || localStorage.getItem('LAST_TABLE_VIEWED');

        if (!tablaDestino || tablaDestino === "undefined") {
            throw new Error("No se pudo determinar la tabla de destino en TABLE_DATA.");
        }

        // 3. OBTENER PREFIJO (Ej: TD213)
        const prefix = tablaDestino.split('_')[0].toUpperCase();

        // 4. CONSTRUCCI√ìN DEL PAYLOAD
        // Extraemos los datos del formulario y a√±adimos los metadatos necesarios
        let payload = {
            action: document.getElementById('formAction')?.value || "registerDynamicDataTD",
            TABLA_DESTINO: tablaDestino,
            CAMPO_CLAVE: `${prefix}ID`,
            ...sanitizePayload(new FormData(e.target)),
            // Forzamos campos de control para el nuevo registro
            [`${prefix}TYPEREG`]: "Registrado",
            [`${prefix}RegistroUser`]: localStorage.getItem('USUARIO_ID') || "1009"
        };

        console.log("üîç [DEBUG] Payload inicial recolectado:", { ...payload });

        // 5. FILTRO DE CAMPOS CALCULADOS
        // Esto evita que campos como NOMBREC (calculado) viajen al backend
        Object.keys(payload).forEach(key => {
            const fieldConf = config[key];
            if (fieldConf) {
                const esCalculado = fieldConf.Es_Calculado === true || 
                                    String(fieldConf.Es_Calculado).toLowerCase() === "true";
                if (esCalculado) {
                    console.log(`üö´ Excluyendo campo calculado del env√≠o: ${key}`);
                    delete payload[key];
                }
            }
        });

        // 6. ASEGURAR ID PARA NUEVO REGISTRO
        // Si el ID viene vac√≠o o con asteriscos, nos aseguramos de que el backend sepa que es nuevo
        if (!payload[`${prefix}ID`] || payload[`${prefix}ID`] === "*******") {
            payload[`${prefix}ID`] = "*******";
        }

        console.log("üöÄ [OK] Enviando Payload Final:", payload);

        // 7. EJECUCI√ìN DEL ENV√çO
        await executeSubmit(payload, 'Registro Creado Satisfactoriamente');

    } catch (error) {
        console.error("‚ùå Error Cr√≠tico en handleInsertSubmit:", error.message);
        // Alert est√°ndar para evitar errores de librer√≠as no cargadas (Swal)
        alert("Atenci√≥n: " + error.message);
    }
}
    function duplicateCurrentRecord() {
        console.log("Iniciando duplicado...");

        // 1. Forzar visibilidad del panel de edici√≥n (por si acaso)
        if (typeof showEditMode === 'function') showEditMode();

        // 2. Cambiar la acci√≥n ANTES de renderizar
        const actionInput = document.getElementById('formAction');
        if (actionInput) {
            actionInput.value = "registerDynamicDataTD";
            console.log("Acci√≥n cambiada a:", actionInput.value);
        }
        
        // 3. Recuperar datos (Usando las mismas llaves que tienes en el DOMContentLoaded)
        // Nota: Si STORAGE_DATA y STORAGE_CONFIG son constantes, aseg√∫rate que sean accesibles.
        // Si fallan, intentamos con los strings directos.
        const rawData = localStorage.getItem('TABLE_DATA'); 
        const rawConfig = localStorage.getItem('TABLE_CONFIG'); 

        if (!rawData || !rawConfig) {
            console.error("Faltan datos en localStorage:", { rawData: !!rawData, rawConfig: !!rawConfig });
            return;
        }

        const data = JSON.parse(rawData);
        const config = JSON.parse(rawConfig);
        const prefix = (data.TABLA_ORIGEN || "").split('_')[0].toUpperCase();

        console.log("Datos recuperados. Prefijo detectado:", prefix);

        // 4. UI: T√≠tulo y Bot√≥n
        document.getElementById('formTitle').textContent = "Nuevo Registro (duplicado)";
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
            submitBtn.innerHTML = `<span>Confirmar y Crear Copia DCR</span><i data-lucide="plus-circle" class="w-5 h-5"></i>`;
            submitBtn.onsubmit = handleInsertSubmit; // Vinculamos al insert
        }
        
        // Vinculamos el formulario al handle de inserci√≥n
        const form = document.getElementById('editDataForm');
        if (form) form.onsubmit = handleInsertSubmit;

        // 5. RE-RENDERIZAR (Esto activar√° tus asteriscos en renderFields)
        console.log("Llamando a renderFields con config y data...");
        renderFields(config, data, false); 

        // 6. Limpieza de campos clave
        setTimeout(() => {
            console.log("Iniciando limpieza de campos clave...");
            const allInputs = document.querySelectorAll('#editDataFormFields input');
            allInputs.forEach(input => {
                const name = input.name.toUpperCase();
                if (name === `${prefix}ID`) return; 

                const isKeyField = name === `${prefix}IDNOMBRE` || name === `${prefix}FECHA` || 
                                name.includes('MONTO') || name.includes('CANTIDAD') || 
                                name.includes('TOTAL') || name.includes('TASA');
                
                if (isKeyField) {
                    input.placeholder = input.value || "";
                    input.value = ""; 
                    input.classList.add('italic', 'text-red-300');
                }
            });
            if (window.lucide) lucide.createIcons();
            console.log("Proceso de duplicado finalizado.");
        }, 100);

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function DeleteRecord() {
        const data = JSON.parse(localStorage.getItem('TABLE_DATA') || localStorage.getItem(STORAGE_DATA) || '{}');
        const tableOrigin = data.TABLA_ORIGEN || "";
        const prefix = tableOrigin.split('_')[0].toUpperCase();
        const keys = JSON.parse(localStorage.getItem('KEYS') || '{}');
        const usuarioLogueado = localStorage.getItem(KEYS.USUARIO_ID) || keys.Usuario_ID;
        const perfilUsuario = String(keys.Usuario_Perfil || "").trim().toUpperCase(); // Perfil del usuario
        const idxCorrecto = localStorage.getItem('Usuario_Idx');
        const ownerKey = `${prefix}REGISTROUSER`;
        const registroOwner = data[ownerKey] || data[`${prefix}RegistroUser`]; 
        const idLogueadoStr = String(usuarioLogueado || "").trim();
        const idOwnerStr = String(registroOwner || "").trim();
        const esAdmin = (perfilUsuario === 'ADMIN');
        const esPropietario = (idOwnerStr !== "" && idOwnerStr === idLogueadoStr);

        if (!esPropietario && !esAdmin) {
            await showSystemModal({ 
                title: 'Acceso Denegado', 
                text: 'Solo el propietario de este registro o un Administrador pueden eliminarlo.', 
                type: 'warning' 
            });
            return;
        }

        const pinIngresado = await showSystemModal({
            title: 'Confirmar Eliminaci√≥n',
            text: 'Este registro ser√° borrado permanentemente. Ingrese su Idx de Seguridad para autorizar:',
            type: 'danger', 
            isPrompt: true,
            placeholder: 'Ingrese su Idx...'
        });

        if (pinIngresado === null) return; 

        if (pinIngresado.trim() !== String(idxCorrecto).trim()) {
            await showSystemModal({ 
                title: 'Error de Seguridad', 
                text: 'El Idx de Seguridad proporcionado es incorrecto. Operaci√≥n abortada.', 
                type: 'warning' 
            });
            return;
        }

        const payload = {
            action: "deleteDynamicDataTD",
            TABLA_DESTINO: tableOrigin,
            CAMPO_CLAVE: `${prefix}ID`,
            [`${prefix}ID`]: data[`${prefix}ID`],
            usuario_id: idLogueadoStr
        };

        try { await executeSubmit(payload, 'Proceso Completado');
            window.location.href = 'Datos2.html';

        } catch (error) {
            console.error("Error al eliminar:", error);
            await showSystemModal({ 
                title: 'Error Cr√≠tico', 
                text: 'No se pudo completar la operaci√≥n en el servidor.', 
                type: 'warning' 
            });
        }
    }

    function showRegisterMode() {
        const duplicateBtn = document.getElementById('btn-duplicate-record');
        const config = JSON.parse(localStorage.getItem(STORAGE_CONFIG));
        const data = JSON.parse(localStorage.getItem(STORAGE_DATA)); 
        const tableName = data.TABLA_ORIGEN;
        if (duplicateBtn) {duplicateBtn.classList.add('hidden');duplicateBtn.style.display = 'none';}  

        document.getElementById('formTitle').textContent = `Nuevo Registro: ${getFriendlyTableName(tableName)}`;
        document.getElementById('formAction').value = "registerDynamicDataTD";
        document.getElementById('submitBtn').textContent = "Crear Nuevo Registro";
        renderFields(config, { TABLA_ORIGEN: tableName }, true);
        togglePanels('edit');
    }

    function showEditMode() {
        const config = JSON.parse(localStorage.getItem(STORAGE_CONFIG));
        const data = JSON.parse(localStorage.getItem(STORAGE_DATA));
        document.getElementById('formTitle').textContent = `Editar: ${getFriendlyTableName(data.TABLA_ORIGEN)}`;
        document.getElementById('formAction').value = "editDynamicDataTD";
        document.getElementById('submitBtn').textContent = "Guardar Cambios SEM";           
        renderFields(config, data, false);
        togglePanels('edit');
    }

    function togglePanels(mode) {
        const detailPanel = document.getElementById('DetalleDataContent');
        const editPanel = document.getElementById('EditDataContent');            
        if (mode === 'edit') {detailPanel.classList.add('hidden'); editPanel.classList.remove('hidden');
        } else {editPanel.classList.add('hidden'); detailPanel.classList.remove('hidden');
        }
    }

    async function fetchMasterData(currentTable) {
        const userTienda = localStorage.getItem(KEYS.TIENDA) || 'DEFAULT';
        const now = Date.now();
        const cacheDuration = 5 * 60 * 1000;
        const tablesToFetch = [{ name: "TV001_VALORES", key: "FULL_DATA_TV001", time: "TV001_TIMESTAMP" }];
        if (currentTable && currentTable !== "TV001_VALORES") {
            const p = currentTable.split('_')[0];
            tablesToFetch.push({ name: currentTable, key: `FULL_DATA_${p}`, time: `${p}_TIMESTAMP` });
        }
        for (const t of tablesToFetch) {
            const lastFetch = localStorage.getItem(t.time);
            if (!localStorage.getItem(t.key) || (now - lastFetch > cacheDuration)) {
                try {
                    const r = await fetch(`${GAS_SCRIPT_URL}?action=getTableData&tableName=${t.name}&userTienda=${userTienda}&ignoreVisibility=true`);
                    const res = await r.json();
                    if (res.success) {
                        localStorage.setItem(t.key, JSON.stringify(res.data));
                        localStorage.setItem(t.time, now.toString());
                    }
                } catch (e) { console.error("Error maestro:", t.name, e); }
            }
        }
    }
</script>
</body>
</html>
